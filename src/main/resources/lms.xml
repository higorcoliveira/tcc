<?xml version="1.0" encoding="UTF-8"?>
<queries>
	<sql>
		<discriminator>QUERY ANET COMPANY AREA</discriminator>
		<select>
			SELECT ACA.COMPANY_AREA, ACA.NAME, ACA.DESCRIPTION,
			CASE
			WHEN EA.STR_ID_EA IS NULL THEN 1 ELSE 0
			END AS "INSERT"
			FROM ANET_COMPANY_AREA ACA
			LEFT JOIN
			$[ANET_DATABASE].dbo.EMPRESA_AREA EA ON ACA.COMPANY_AREA = EA.STR_ID_EA
		</select>
	</sql>
	<sql>
		<discriminator>QUERY ANET COMPANY HIERARCHY</discriminator>
		<select>
			SELECT ACH.COMPANY_HIERACHY, ACH.NAME, ACH.DESCRIPTION,
			CASE
			WHEN EH.STR_ID_EH IS NULL THEN 1 ELSE 0
			END AS "INSERT"
			FROM ANET_COMPANY_HIERACHY ACH
			LEFT JOIN
			$[ANET_DATABASE].dbo.EMPRESA_HIERARQUIA EH ON ACH.COMPANY_HIERACHY = EH.STR_ID_EH
		</select>
	</sql>
	<sql>
		<discriminator>QUERY ANET PARTICIPANT TO INSERT</discriminator>
		<select>
			BEGIN
				DECLARE @BASE_ID INT;
				SELECT @BASE_ID = MAX(ID) FROM  $[ANET_DATABASE].dbo.Participante;
				
				INSERT INTO $[ANET_DATABASE].dbo.Participante (ID, NOME, EMAIL, STR_ID_EA, STR_ID_EH, IDENTIFICACAO, SENHA, ATIVO, SEXO,
						CPF, OPCIONAL01, OPCIONAL02, ESTADOCIVIL, ESCOLARIDADE, OPCIONAL03, DATAADMISSAO, RG, OPCIONAL06, OPCIONAL07,
						TIPO, GERENTE, DIANASCIMENTO, MESNASCIMENTO, ANONASCIMENTO, DATACRIACAO, TELEFONE)
				SELECT ROW_NUMBER() OVER(ORDER BY NAME ASC)+@BASE_ID, AP.NAME, AP.EMAIL, AP.COMPANY_AREA, AP.COMPANY_HIERACHY, AP.RE, AP.PASSWORD, AP.ACTIVE, AP.GENDER, 
					AP.CPF, AP.CONTRACT, AP.RE_SUPERIOR, AP.MARITAL_STATUS, AP.SCHOLARITY, AP.COST_CENTER, AP.ADMISSION_DATE, AP.RG, AP.EXECUTIVE_BOARD, AP.CONSULTING_NAME, 1, 0, DAY( AP.FULLBIRTHDAY), MONTH( AP.FULLBIRTHDAY), YEAR( AP.FULLBIRTHDAY), GETDATE(), AP.PHONE
					FROM ANET_PARTICIPANT AP
					LEFT JOIN $[ANET_DATABASE].dbo.Participante P ON AP.RE = P.IDENTIFICACAO
					WHERE P.ID IS NULL AND NOT EXISTS (SELECT ID FROM $[ANET_DATABASE].dbo.Participante WHERE CPF = AP.CPF)				
			END
		</select>
	</sql>
	<sql>
		<discriminator>QUERY ANET PARTICIPANT TO UPDATE</discriminator>
		<select>
			UPDATE $[ANET_DATABASE].dbo.Participante
			SET STR_ID_EA = AP.COMPANY_AREA, STR_ID_EH = AP.COMPANY_HIERACHY, IDENTIFICACAO = AP.RE, NOME = AP.NAME,
			EMAIL = AP.EMAIL, ATIVO = AP.ACTIVE, SEXO = AP.GENDER, CPF = AP.CPF, OPCIONAL01 = AP.CONTRACT, 
			OPCIONAL02 = AP.RE_SUPERIOR, ESTADOCIVIL = AP.MARITAL_STATUS, ESCOLARIDADE = AP.SCHOLARITY, OPCIONAL03 = AP.COST_CENTER, 
			DATAADMISSAO = AP.ADMISSION_DATE, RG = AP.RG, OPCIONAL06 = AP.EXECUTIVE_BOARD, OPCIONAL07 = AP.CONSULTING_NAME,
			DIANASCIMENTO = DAY(AP.FULLBIRTHDAY), MESNASCIMENTO = MONTH(AP.FULLBIRTHDAY), ANONASCIMENTO = YEAR(AP.FULLBIRTHDAY), TELEFONE = AP.PHONE
			FROM $[ANET_DATABASE].dbo.Participante P
			INNER JOIN (
				SELECT P.ID PARTICIPANT_ID, AP.NAME, AP.EMAIL, AP.COMPANY_AREA, AP.COMPANY_HIERACHY, AP.RE, AP.PASSWORD, AP.ACTIVE, AP.GENDER, AP.FULLBIRTHDAY, AP.CPF, 
				AP.CONTRACT, AP.RE_SUPERIOR, AP.MARITAL_STATUS, AP.SCHOLARITY, AP.COST_CENTER, AP.ADMISSION_DATE, AP.RG, AP.EXECUTIVE_BOARD, AP.CONSULTING_NAME, AP.PHONE
				FROM ANET_PARTICIPANT AP
				INNER JOIN $[ANET_DATABASE].dbo.Participante P ON AP.RE = P.IDENTIFICACAO
				UNION
				SELECT P.ID PARTICIPANT_ID, AP.NAME, AP.EMAIL, AP.COMPANY_AREA, AP.COMPANY_HIERACHY, AP.RE, AP.PASSWORD, AP.ACTIVE, AP.GENDER, AP.FULLBIRTHDAY, AP.CPF, 
				AP.CONTRACT, AP.RE_SUPERIOR, AP.MARITAL_STATUS, AP.SCHOLARITY, AP.COST_CENTER, AP.ADMISSION_DATE, AP.RG, AP.EXECUTIVE_BOARD, AP.CONSULTING_NAME, AP.PHONE
				FROM ANET_PARTICIPANT AP
				INNER JOIN $[ANET_DATABASE].dbo.Participante P ON AP.CPF = P.CPF
			) AS AP ON AP.PARTICIPANT_ID = P.ID
		</select>
	</sql>
	<sql>
		<discriminator>QUERY ANET HIERARCHY DELETE</discriminator>
		<select>
			DELETE FROM $[ANET_DATABASE].dbo.GerenteParticipante WHERE IDPARTICIPANTE IN (SELECT DISTINCT P.ID FROM $[ANET_DATABASE].dbo.Participante P
			INNER JOIN ANET_MANAGER_PARTICIPANT MP ON MP.MANAGER_RE = P.IDENTIFICACAO OR MP.PARTICIPANT_RE = P.IDENTIFICACAO)
			
			DELETE FROM $[ANET_DATABASE].dbo.GerenteParticipante WHERE IDPARTICIPANTESUBORDINADO IN (SELECT DISTINCT P.ID FROM $[ANET_DATABASE].dbo.Participante P
			INNER JOIN ANET_MANAGER_PARTICIPANT MP ON MP.MANAGER_RE = P.IDENTIFICACAO OR MP.PARTICIPANT_RE = P.IDENTIFICACAO)
		</select>
	</sql>
	<sql>
		<discriminator>QUERY ANET HIERARCHY INSERT</discriminator>
		<select>
		<![CDATA[
			WITH Hierarchy
			AS ( 
				SELECT
					AMP1.PARTICIPANT_RE,
					AMP1.MANAGER_RE
				FROM
					ANET_MANAGER_PARTICIPANT AMP1 WHERE AMP1.PARTICIPANT_RE <> AMP1.MANAGER_RE
			UNION ALL 
				SELECT 
					Hierarchy.PARTICIPANT_RE, 
					AMP.MANAGER_RE 
				FROM 
					ANET_MANAGER_PARTICIPANT AMP
				INNER JOIN 
					Hierarchy ON AMP.PARTICIPANT_RE = Hierarchy.MANAGER_RE AND AMP.PARTICIPANT_RE <> AMP.MANAGER_RE
			)
			INSERT INTO $[ANET_DATABASE].dbo.GerenteParticipante
			SELECT P.ID, P2.ID FROM Hierarchy H
			INNER JOIN $[ANET_DATABASE].dbo.Participante P ON H.MANAGER_RE = P.IDENTIFICACAO
			INNER JOIN $[ANET_DATABASE].dbo.Participante P2 ON H.PARTICIPANT_RE = P2.IDENTIFICACAO
		]]>
		</select>
	</sql>
</queries>